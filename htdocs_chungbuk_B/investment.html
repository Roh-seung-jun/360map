<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="bootstrap-4.3.1-dist/css/bootstrap.css">
    <script src="jquery-3.6.0.js"></script>
    <script src="jquery-ui-1.12.1.custom/jquery-ui.js"></script>
    <script src="bootstrap-4.3.1-dist/js/bootstrap.js"></script>

    <style>
        .bar{
            border-radius: 7px;
            background-color: #ccc;
        }
    </style>
    <script>
        $(()=>{
            if(!localStorage.pay)localStorage.pay = [];
            window.draw = false;
            let arr = getData();
            let table = '';
            let today = new Date().toISOString().substring(0, 10);
            arr.forEach((e,idx)=>{
                let button = '모집완료';
                if(new Date(today) <= new Date(e['end_date'])){
                    button = `<button class="btn btn-outline-primary" onclick="clickEvent(${idx})" data-toggle="modal" data-target="#view">투자하기</button>`
                }
                table += `
                <tr>
                    <td>${e.number}</td>
                    <td>${e.writer}</td>
                    <td>${e.start_date} ~ ${e.end_date}</td>
                    <td>${e.money}</td>
                </tr>
            <tr>
                <td colspan="3">
                <div class="bar text-center p-1 position-relative overflow-hidden" style="z-index: -99">
                <p class="m-0" style="z-index: 99">${Math.floor(e['join']/e['money'] *100)}%</p>
                <div class="position-absolute h-100" style="z-index: -1;background-color: #34ce57;top:0;left: 0;border-radius: 7px;width: ${e['join']/e['money'] *100}%;"></div>
                </div>
</td>
<td>${button}</td>
            </tr>`;
            })
            $('table .data-push').html(table);

            $(document)
            .on('mousedown','#canvas',startDraw)
            .on('mousemove','#canvas',drawing)
            .on('mouseup','#canvas',()=> window.draw = false)
        })

        function startDraw(e){
            window.draw = true;
            let ctx = getCtx('canvas');
            ctx.beginPath();
            ctx.moveTo(e.offsetX,e.offsetY);
        }

        function drawing(e){
            if(!window.draw) return
            let ctx = getCtx('canvas');
            ctx.lineTo(e.offsetX,e.offsetY);
            ctx.stroke();
        }

        function getCtx(id){
            return $(`#${id}`)[0].getContext('2d');
        }

        function clickEvent(index){
            window.index = index;
            let arr = getData();
            let data = arr[index];
            $('#writer').val(data.writer);
            $('#number').val(data.number);
        }

        function getData(){
            let arr = [];
            if(localStorage.user){
                arr = JSON.parse(localStorage.user);
            }
            return arr;
        }

        function investment(){

            let writer = $('#writer').val(),
                number = $('#number').val(),
                name = $('#name').val(),
                join = $('#join').val();
            let ctx = getCtx('canvas');
            let isValid = ctx.getImageData(0, 0, 700, 100).data.some(channel => channel !== 0);

            if( !writer || !number || !name|| !join || !isValid) return alert('필수값이 누락되었습니다.');

            let arr = getData();
            arr[window.index]['join'] += join;
            localStorage.user = JSON.stringify(arr);

            let pay = [];
            if(localStorage.pay) pay = JSON.parse(localStorage.pay);

            pay.push({
                writer,
                number,
                join,
                name,
                'image' : $('#canvas')[0].toDataURL()
            })
            localStorage.pay = JSON.stringify(pay);
        }
    </script>
</head>
<body style="height: 100vh">
    <div class="d-flex justify-content-center w-100">
        <table class="table w-50" style="margin-top: 200px">
            <thead class="thead-light">
            <tr>
                <td>투자번호</td>
                <td>청년작가 이름</td>
                <td>모집기간</td>
                <td>모집목표금액</td>
            </tr>
            </thead>
            <tbody class="data-push">
            </tbody>
        </table>
    </div>

    <div class="modal fade example-modal-lg" id="view" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <p>투자번호</p>
                        <input type="text" class="form-control" id="number" readonly>
                    </div>
                    <div class="form-group">
                        <p>청년작가</p>
                        <input type="text" class="form-control" id="writer" readonly>
                    </div>
                    <div class="form-group">
                        <p>투자자명</p>
                        <input type="text" class="form-control" id="name">
                    </div>
                    <div class="form-group">
                        <p>투자금액</p>
                        <input type="number" class="form-control" id="join">
                    </div>
                    <div class="form-group">
                        <p>서명란</p>
                        <canvas id="canvas" width="700" height="100" style="border: 1px solid #ccc"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="investment()">입력 완료</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>